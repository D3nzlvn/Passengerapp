</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Passenger Bus Tracker</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

        // 🔹 Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDrjD_xmVik9567ns9MeC9aNjcg3Rj7L94",
            authDomain: "fleettracking-37db2.firebaseapp.com",
            databaseURL: "https://fleettracking-37db2-default-rtdb.firebaseio.com",
            projectId: "fleettracking-37db2",
            storageBucket: "fleettracking-37db2.firebasestorage.app",
            messagingSenderId: "328558300951",
            appId: "1:328558300951:android:b88d97f56efb1fdfb83152"
        };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const stops = [
      { lat: 14.53951, lng: 121.05401, name: "C5 McKinley Hill Terminal" },
      { lat: 14.53458, lng: 121.05869, name: "CIP Building" },
      { lat: 14.53612, lng: 121.04508, name: "West Campus" },
      { lat: 14.53243, lng: 121.05324, name: "Science Hub Tower 1" },
      { lat: 14.53133, lng: 121.05327, name: "Science Hub 3" },
      { lat: 14.53178, lng: 121.05373, name: "Wells Fargo" },
      { lat: 14.53296, lng: 121.05298, name: "Venice Mall Entrance: Kenny Rogers" },
      { lat: 14.53303, lng: 121.05069, name: "Venice Mall Tunnel Entrance" },
    ];

    let map;
    let busMarker = null;
    let nextStopMarker = null;

    window.initMap = async function () {
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: { lat: 14.53458, lng: 121.05869 },
        zoom: 15,
        disableDefaultUI: true,
        mapId: "YOUR_MAP_ID", // 🔧 Replace with your Map ID from Google Cloud
      });

      const stopsListDiv = document.getElementById("stopsList");
      stops.forEach((s) => {
        const div = document.createElement("div");
        div.className = "stop";
        div.innerText = "• " + s.name;
        stopsListDiv.appendChild(div);
      });

      const driversRef = ref(db, "drivers");
      onValue(driversRef, (snapshot) => {
        if (!snapshot.exists()) return;

        const driver = Object.values(snapshot.val())[0]?.latest;
        if (!driver) return;

        const { latitude, longitude, nextStopIndex, etaText } = driver;
        if (!latitude || !longitude) return;

        const pos = new google.maps.LatLng(latitude, longitude);

        // 🚌 Bus Marker (custom icon)
        if (!busMarker) {
          const busIcon = document.createElement("img");
          busIcon.src = "bus-icon.png"; // use your custom icon
          busIcon.style.width = "50px";
          busIcon.style.height = "50px";

          busMarker = new AdvancedMarkerElement({
            map,
            position: pos,
            title: "Bus",
            content: busIcon,
          });
          map.setCenter(pos);
        } else {
          busMarker.position = pos;
        }

        // 🕓 Update ETA and Next Stop
        const nextStopText = document.getElementById("nextStopText");
        const etaDisplay = document.getElementById("etaText");
        const stopsList = document.getElementById("stopsList").children;

        if (typeof nextStopIndex === "number" && stops[nextStopIndex]) {
          const stop = stops[nextStopIndex];
          nextStopText.innerText = `Next Stop: ${stop.name}`;
          etaDisplay.innerText = `ETA: ${etaText || "Calculating..."}`;

          for (let i = 0; i < stopsList.length; i++) {
            stopsList[i].classList.toggle("highlight", i === nextStopIndex);
          }

          // 📍 Next Stop Marker (only one)
          if (!nextStopMarker) {
            const stopIcon = document.createElement("img");
            stopIcon.src = "stop-icon.png"; // use your stop pin icon
            stopIcon.style.width = "40px";
            stopIcon.style.height = "40px";

            nextStopMarker = new AdvancedMarkerElement({
              map,
              position: new google.maps.LatLng(stop.lat, stop.lng),
              title: stop.name,
              content: stopIcon,
            });
          } else {
            nextStopMarker.position = new google.maps.LatLng(stop.lat, stop.lng);
          }
        }
      });
    };
  </script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: #f8f9fa;
    }

    #map {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    .info-card {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      padding: 16px 20px;
      width: 90%;
      max-width: 420px;
      transition: all 0.3s ease;
    }

    .info-card h2 {
      margin: 0;
      font-size: 18px;
      color: #007aff;
    }

    .info-card p {
      margin: 6px 0;
      color: #333;
    }

    .stops-list {
      max-height: 120px;
      overflow-y: auto;
      margin-top: 8px;
      scrollbar-width: none;
    }

    .stop {
      font-size: 15px;
      color: #555;
      padding: 3px 0;
    }

    .highlight {
      color: #007aff;
      font-weight: bold;
    }

    /* 📱 Mobile responsive adjustments */
    @media (max-width: 600px) {
      .info-card {
        bottom: 10px;
        padding: 14px 16px;
        width: 94%;
        font-size: 14px;
      }

      .info-card h2 {
        font-size: 16px;
      }

      .stop {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="info-card">
    <h2 id="nextStopText">Next Stop: --</h2>
    <p id="etaText">ETA: --</p>
    <p><strong>All Stops:</strong></p>
    <div id="stopsList" class="stops-list"></div>
  </div>

  <!-- ✅ Async load Maps JS -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxLu0osGhSyZCJt5TGO-gSPuGydL_u7XE&callback=initMap&loading=async&libraries=maps,marker"
    async defer>
  </script>
</body>
</html>
