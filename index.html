<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Passenger Bus Tracker</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDrjD_xmVik9567ns9MeC9aNjcg3Rj7L94",
      authDomain: "fleettracking-37db2.firebaseapp.com",
      databaseURL: "https://fleettracking-37db2-default-rtdb.firebaseio.com",
      projectId: "fleettracking-37db2",
      storageBucket: "fleettracking-37db2.firebasestorage.app",
      messagingSenderId: "328558300951",
      appId: "1:328558300951:android:b88d97f56efb1fdfb83152"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // üó∫Ô∏è Fixed Bus Routes
    const routeStops = {
      "Route 1": [
        { lat: 14.53951, lng: 121.05401, name: "C5 McKinley Hill Terminal" },
        { lat: 14.53436, lng: 121.05257, name: "CIP Building" },
        { lat: 14.53249, lng: 121.05213, name: "Science Hub Tower 1" },
        { lat: 14.53133, lng: 121.05327, name: "Science Hub 3" },
        { lat: 14.53178, lng: 121.05373, name: "Wells Fargo" },
        { lat: 14.53296, lng: 121.05298, name: "Venice Mall Entrance: Kenny Rogers" },
        { lat: 14.53303, lng: 121.05069, name: "Venice Mall Tunnel Entrance" },
        { lat: 14.53612, lng: 121.04508, name: "West Campus" }
      ],
      "Route 2": [
        { lat: 14.53579, lng: 121.04868, name: "Lawton Avenue, Upper McKinley Hill" },
        { lat: 14.53479, lng: 121.04937, name: "Metrobank Two World Square" },
        { lat: 14.53303, lng: 121.05069, name: "Venice Mall Tunnel Entrance" },
        { lat: 14.53296, lng: 121.05298, name: "Venice Mall Entrance: Kenny Rogers" },
        { lat: 14.53178, lng: 121.05373, name: "Wells Fargo" },
        { lat: 14.53133, lng: 121.05327, name: "Science Hub 3" },
        { lat: 14.53243, lng: 121.05324, name: "Science Hub Tower 1" },
        { lat: 14.53436, lng: 121.05257, name: "CIP Building" },
        { lat: 14.53612, lng: 121.04508, name: "West Campus" },
        { lat: 14.53579, lng: 121.04868, name: "Lawton Avenue, Upper McKinley Hill" }
      ],
      "Route 3": [
        { lat: 14.53898, lng: 121.04571, name: "McKinley West Village" },
        { lat: 14.53611, lng: 121.04369, name: "Asia Town Park" },
        { lat: 14.53424, lng: 121.04933, name: "McKinley Information Center" },
        { lat: 14.53468, lng: 121.05074, name: "Venice Mall" },
        { lat: 14.53303, lng: 121.05069, name: "Venice Mall Tunnel Entrance" },
        { lat: 14.53296, lng: 121.05298, name: "Venice Mall Entrance: Kenny Rogers" },
        { lat: 14.53178, lng: 121.05373, name: "Wells Fargo" },
        { lat: 14.53133, lng: 121.05327, name: "Science Hub 3" },
        { lat: 14.53243, lng: 121.05324, name: "Science Hub Tower 1" },
        { lat: 14.53436, lng: 121.05257, name: "CIP Building" },
        { lat: 14.53612, lng: 121.04508, name: "West Campus" },
        { lat: 14.53579, lng: 121.04868, name: "Lawton Avenue, Upper McKinley Hill" },
        { lat: 14.53898, lng: 121.04571, name: "McKinley West Village" }
      ]
    };

    let map;
    let busMarkers = {};
    let nextStopMarkers = {};

    // ‚úÖ Initialize Map (keep your mapId)
    window.initMap = function () {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 14.53458, lng: 121.05269 },
        zoom: 15,
        disableDefaultUI: true,
        mapId: "f49cf1e515cbf4b6e3c25fb7"
      });

      const busListDiv = document.getElementById("busList");
      const driversRef = ref(db, "drivers");

      onValue(driversRef, (snapshot) => {
        busListDiv.innerHTML = "";
        if (!snapshot.exists()) return;
        const drivers = snapshot.val();

        Object.entries(drivers).forEach(([driverId, data]) => {
          const latest = data.latest;
          if (!latest) return;

          const routeName = latest.selectedRoute || "Route 1";
          const stops = routeStops[routeName] || routeStops["Route 1"];
          const busName = latest.busName || "Bus A";
          const { latitude, longitude, etaText, nextStop } = latest;
          if (!latitude || !longitude) return;

          const pos = new google.maps.LatLng(latitude, longitude);
          const nextStopObj = stops.find(s => s.name === nextStop) || stops[0];
          const etaDisplay = etaText || "Calculating...";

          // üöå Create or Update Bus Marker
          if (!busMarkers[driverId]) {
            busMarkers[driverId] = new google.maps.Marker({
              position: pos,
              map: map,
              title: busName,
              icon: {
                url: "bus-icon.png",
                scaledSize: new google.maps.Size(45, 45),
                anchor: new google.maps.Point(22, 22)
              }
            });
          } else {
            busMarkers[driverId].setPosition(pos);
          }

          // üìç Create or Update Next Stop Marker
          if (!nextStopMarkers[driverId]) {
            nextStopMarkers[driverId] = new google.maps.Marker({
              position: { lat: nextStopObj.lat, lng: nextStopObj.lng },
              map: map,
              title: `Next Stop: ${nextStopObj.name}`,
              icon: {
                url: "stop-icon.png",
                scaledSize: new google.maps.Size(38, 38),
                anchor: new google.maps.Point(19, 19)
              }
            });
          } else {
            nextStopMarkers[driverId].setPosition({ lat: nextStopObj.lat, lng: nextStopObj.lng });
          }

          // üìù Bus Info UI
          const busDiv = document.createElement("div");
          busDiv.className = "bus-info";
          busDiv.innerHTML = `
            <div class="bus-header">
              <div class="bus-title">${busName}</div>
              <div class="bus-details">
                <div><strong>üïí ETA:</strong> ${etaDisplay}</div>
                <div><strong>üìç Next Stop:</strong> ${nextStopObj.name}</div>
                <div><strong>üõ£ Route:</strong> ${routeName}</div>
              </div>
            </div>
            <div class="stops-list">
              ${stops.map(s => `
                <div class="stop-item ${s.name === nextStopObj.name ? "highlight" : ""}">
                  ‚Ä¢ ${s.name}
                </div>
              `).join("")}
            </div>
          `;
          busListDiv.appendChild(busDiv);
        });
      });
    };
  </script>

 <style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: "Poppins", Arial, sans-serif;
    background: #f8f9fa;
    overflow: hidden;
  }

  #map {
    height: 100%;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }

  .info-card {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 320px;
    background: rgba(255, 255, 255, 0.97);
    box-shadow: 3px 0 15px rgba(0, 0, 0, 0.15);
    padding: 16px 20px;
    overflow-y: auto;
    border-radius: 0 20px 20px 0;
  }

  .bus-info {
    margin-bottom: 16px;
    padding: 14px 18px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  }

  .bus-title {
    font-size: 20px;
    font-weight: 600;
    color: #007aff;
    margin-bottom: 8px;
  }

  .bus-details {
    font-size: 16px;
    color: #333;
    line-height: 1.6;
  }

  .bus-details div {
    margin-bottom: 4px;
  }

  .stops-list {
    margin-top: 10px;
    padding-left: 12px;
    border-left: 3px solid #007aff33;
  }

  .stop-item {
    font-size: 15px;
    color: #555;
    margin: 4px 0;
  }

  .highlight {
    color: #007aff;
    font-weight: 600;
    font-size: 16px;
  }

  h2 {
    margin-top: 0;
    margin-bottom: 12px;
    font-size: 20px;
    color: #333;
    text-align: center;
  }

  @media (max-width: 768px) {
    .info-card {
      bottom: 0;
      top: auto;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      height: auto;
      max-height: 55%;
      border-radius: 20px 20px 0 0;
    }

    .bus-title {
      font-size: 18px;
    }

    .bus-details {
      font-size: 14px;
    }

    .stop-item {
      font-size: 13px;
    }
  }
</style>

</head>

<body>
  <div id="map"></div>

  <div class="info-card">
    <h2>üöå Active Buses</h2>
    <div id="busList"></div>
  </div>

  <!-- ‚úÖ Classic loader (keeps your mapId and removes importLibrary error) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxLu0osGhSyZCJt5TGO-gSPuGydL_u7XE&callback=initMap&libraries=geometry"
    async defer></script>
</body>
</html>
