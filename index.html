<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Passenger Bus Tracker</title>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDrjD_xmVik9567ns9MeC9aNjcg3Rj7L94",
      authDomain: "fleettracking-37db2.firebaseapp.com",
      databaseURL: "https://fleettracking-37db2-default-rtdb.firebaseio.com",
      projectId: "fleettracking-37db2",
      storageBucket: "fleettracking-37db2.firebasestorage.app",
      messagingSenderId: "328558300951",
      appId: "1:328558300951:android:b88d97f56efb1fdfb83152"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // üó∫Ô∏è Bus Route (same as in Android driver app)
    const routeStops = {
      "Route 1": [
        { lat: 14.53951, lng: 121.05401, name: "C5 McKinley Hill Terminal" },
        { lat: 14.53458, lng: 121.05869, name: "CIP Building" },
        { lat: 14.53243, lng: 121.05324, name: "Science Hub Tower 1" },
        { lat: 14.53133, lng: 121.05327, name: "Science Hub 3" },
        { lat: 14.53178, lng: 121.05373, name: "Wells Fargo" },
        { lat: 14.53296, lng: 121.05298, name: "Venice Mall Entrance: Kenny Rogers" },
        { lat: 14.53303, lng: 121.05069, name: "Venice Mall Tunnel Entrance" },
        { lat: 14.53612, lng: 121.04508, name: "West Campus" }
      ]
    };

    let map;
    let busMarkers = {};
    let stopMarkers = {};
    let snapshotCache = null;
    let mapReady = false;

    // ‚úÖ Initialize Map
    window.initMap = function () {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 14.53458, lng: 121.05269 },
        zoom: 15,
        disableDefaultUI: false,
        mapId: "f49cf1e515cbf4b6e3c25fb7"
      });

      mapReady = true;
      if (snapshotCache) updateMap(snapshotCache);
    };

    // üîÅ Firebase Realtime Listener
    const driversRef = ref(db, "drivers");
    onValue(driversRef, (snapshot) => {
      snapshotCache = snapshot;
      if (mapReady) updateMap(snapshot);
    });

    // üîÑ Update Map + Sidebar
    function updateMap(snapshot) {
      const busListDiv = document.getElementById("busList");
      busListDiv.innerHTML = "";

      if (!snapshot.exists()) return;
      const drivers = snapshot.val();

      Object.entries(drivers).forEach(([driverId, data]) => {
        const latest = data.latest;
        if (!latest || !latest.latitude || !latest.longitude) return;

        const route = latest.route || "Route 1";
        const stops = routeStops[route] || [];
        const busName = latest.busName || "Bus";
        const { latitude, longitude, etaMinutes, nextStop, status } = latest;

        const pos = new google.maps.LatLng(latitude, longitude);
        const nextStopObj = stops.find(s => s.name === nextStop) || stops[0];

        // üöå Bus Marker
        if (!busMarkers[driverId]) {
          busMarkers[driverId] = new google.maps.Marker({
            position: pos,
            map: map,
            title: busName,
            icon: {
              url: "bus-icon.png", // ‚Üê use your image file name here
              scaledSize: new google.maps.Size(48, 48), // adjust size if needed
              anchor: new google.maps.Point(24, 24)
            }
          });
        } else {
          busMarkers[driverId].setPosition(pos);
        }


        // üìç Create/Update Stop Marker
        if (!stopMarkers[driverId]) {
          stopMarkers[driverId] = new google.maps.Marker({
            position: { lat: nextStopObj.lat, lng: nextStopObj.lng },
            map: map,
            title: `Next Stop: ${nextStopObj.name}`,
            icon: {
              url: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
              scaledSize: new google.maps.Size(35, 35)
            }
          });
        } else {
          stopMarkers[driverId].setPosition({ lat: nextStopObj.lat, lng: nextStopObj.lng });
        }

        // üìù Bus Info Card
        const etaText = etaMinutes ? `${etaMinutes} min` : "Calculating...";
        const busDiv = document.createElement("div");
        busDiv.className = "bus-card";
        busDiv.innerHTML = `
          <div class="bus-header">
            <div class="bus-name">${busName}</div>
            <div class="bus-route">${route}</div>
          </div>
          <div class="bus-status ${status.includes('Arriv') ? 'status-arriving' :
                                   status.includes('Left') ? 'status-left' :
                                   status.includes('Complete') ? 'status-done' :
                                   'status-enroute'}">
            ${status}
          </div>
          <div class="bus-info">
            <div><strong>üìç Next Stop:</strong> ${nextStopObj.name}</div>
            <div><strong>üïí ETA:</strong> ${etaText}</div>
          </div>
          <div class="stops">
            ${stops.map(s => `
              <div class="stop ${s.name === nextStopObj.name ? "active" : ""}">
                ‚Ä¢ ${s.name}
              </div>
            `).join("")}
          </div>
        `;
        busListDiv.appendChild(busDiv);
      });
    }
  </script>

  <!-- ‚úÖ Styles -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: #f8f9fa;
      overflow: hidden;
    }

    #map {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }

    .sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 340px;
      height: 100%;
      background: white;
      box-shadow: 4px 0 15px rgba(0,0,0,0.15);
      z-index: 5;
      overflow-y: auto;
      border-radius: 0 20px 20px 0;
      padding: 16px 20px;
    }

    h2 {
      text-align: center;
      margin: 10px 0 20px;
      font-weight: 600;
      color: #333;
    }

    .bus-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 14px 18px;
      margin-bottom: 18px;
    }

    .bus-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .bus-name {
      font-size: 18px;
      font-weight: 600;
      color: #007aff;
    }

    .bus-route {
      font-size: 13px;
      color: #777;
    }

    .bus-status {
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 13px;
      text-align: center;
      font-weight: 500;
      width: fit-content;
    }

    .status-arriving { background: #e3f2fd; color: #007aff; }
    .status-left { background: #fff3cd; color: #a67c00; }
    .status-enroute { background: #e8f5e9; color: #2e7d32; }
    .status-done { background: #fbe9e7; color: #d84315; }

    .bus-info {
      margin-top: 10px;
      color: #333;
      font-size: 15px;
      line-height: 1.6;
    }

    .stops {
      margin-top: 10px;
      padding-left: 10px;
      border-left: 3px solid #007aff33;
    }

    .stop {
      font-size: 14px;
      color: #555;
      margin: 3px 0;
      transition: 0.2s;
    }

    .stop.active {
      color: #007aff;
      font-weight: 600;
      transform: translateX(4px);
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 95%;
        left: 50%;
        transform: translateX(-50%);
        top: auto;
        bottom: 0;
        border-radius: 20px 20px 0 0;
        height: 45%;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.15);
      }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="sidebar">
    <h2>üöå Active Buses</h2>
    <div id="busList"></div>
  </div>

  <!-- ‚úÖ Google Maps Script -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxLu0osGhSyZCJt5TGO-gSPuGydL_u7XE&callback=initMap"
    async defer></script>
</body>
</html>
