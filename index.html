<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Passenger Bus Tracker</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDrjD_xmVik9567ns9MeC9aNjcg3Rj7L94",
      authDomain: "fleettracking-37db2.firebaseapp.com",
      databaseURL: "https://fleettracking-37db2-default-rtdb.firebaseio.com",
      projectId: "fleettracking-37db2",
      storageBucket: "fleettracking-37db2.firebasestorage.app",
      messagingSenderId: "328558300951",
      appId: "1:328558300951:android:b88d97f56efb1fdfb83152"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // üó∫Ô∏è Fixed Bus Routes
    const routeStops = {
      "Route 1": [
        { lat: 14.53951, lng: 121.05401, name: "C5 McKinley Hill Terminal" },
        { lat: 14.53436, lng: 121.05257, name: "CIP Building" },
        { lat: 14.53249, lng: 121.05213, name: "Science Hub Tower 1" },
        { lat: 14.53133, lng: 121.05327, name: "Science Hub 3" },
        { lat: 14.53178, lng: 121.05373, name: "Wells Fargo" },
        { lat: 14.53296, lng: 121.05298, name: "Venice Mall Entrance: Kenny Rogers" },
        { lat: 14.53303, lng: 121.05069, name: "Venice Mall Tunnel Entrance" },
        { lat: 14.53612, lng: 121.04508, name: "West Campus" }
      ]
    };

    let map;
    let busMarkers = {};
    let nextStopMarkers = {};
    let firebaseData = null;
    let mapReady = false;

    // ‚úÖ Initialize Map
    window.initMap = function () {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 14.53458, lng: 121.05269 },
        zoom: 15,
        disableDefaultUI: true,
        mapId: "f49cf1e515cbf4b6e3c25fb7"
      });
      mapReady = true;

      // If Firebase already loaded, render immediately
      if (firebaseData) updateMap(firebaseData);
    };

    // üîÅ Firebase real-time updates
    const driversRef = ref(db, "drivers");
    onValue(driversRef, (snapshot) => {
      firebaseData = snapshot;
      if (mapReady) updateMap(snapshot);
    });

    // üîÑ Update Map + Sidebar
    function updateMap(snapshot) {
      const busListDiv = document.getElementById("busList");
      busListDiv.innerHTML = "";
      if (!snapshot.exists()) return;

      const drivers = snapshot.val();

      Object.entries(drivers).forEach(([driverId, data]) => {
        const latest = data.latest;
        if (!latest) return;

        const routeName = latest.selectedRoute || "Route 1";
        const stops = routeStops[routeName] || [];
        const busName = latest.busName || "Bus A";
        const { latitude, longitude, etaMinutes, nextStop } = latest;

        if (!latitude || !longitude) return;
        const pos = new google.maps.LatLng(latitude, longitude);
        const nextStopObj = stops.find(s => s.name === nextStop) || stops[0];
        const etaDisplay = etaMinutes ? `${etaMinutes} min` : "Calculating...";

        // üöå Create / Update Bus Marker
        if (!busMarkers[driverId]) {
          busMarkers[driverId] = new google.maps.Marker({
            position: pos,
            map: map,
            title: busName,
            icon: {
              url: "bus-icon.png",
              scaledSize: new google.maps.Size(45, 45),
              anchor: new google.maps.Point(22, 22)
            }
          });
        } else {
          busMarkers[driverId].setPosition(pos);
        }

        // üìç Create / Update Next Stop Marker
        if (!nextStopMarkers[driverId]) {
          nextStopMarkers[driverId] = new google.maps.Marker({
            position: { lat: nextStopObj.lat, lng: nextStopObj.lng },
            map: map,
            title: `Next Stop: ${nextStopObj.name}`,
            icon: {
              url: "stop-icon.png",
              scaledSize: new google.maps.Size(38, 38),
              anchor: new google.maps.Point(19, 19)
            }
          });
        } else {
          nextStopMarkers[driverId].setPosition({ lat: nextStopObj.lat, lng: nextStopObj.lng });
        }

        // üìù Bus Info Card
        const busDiv = document.createElement("div");
        busDiv.className = "bus-info";
        busDiv.innerHTML = `
          <div class="bus-header">
            <div class="bus-title">${busName}</div>
            <div class="bus-subtitle">üõ£ ${routeName}</div>
          </div>
          <div class="bus-details">
            <div><strong>üìç Next Stop:</strong> ${nextStopObj.name}</div>
            <div><strong>üïí ETA:</strong> ${etaDisplay}</div>
          </div>
          <div class="stops-list">
            ${stops.map(s => `
              <div class="stop-item ${s.name === nextStopObj.name ? "highlight" : ""}">
                ‚Ä¢ ${s.name}
              </div>
            `).join("")}
          </div>
        `;
        busListDiv.appendChild(busDiv);
      });
    }
  </script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: #f8f9fa;
      overflow: hidden;
    }

    #map {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    .info-card {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 340px;
      background: rgba(255, 255, 255, 0.97);
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.15);
      padding: 16px 20px;
      overflow-y: auto;
      border-radius: 0 20px 20px 0;
    }

    .bus-info {
      margin-bottom: 20px;
      padding: 16px 20px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .bus-title {
      font-size: 20px;
      font-weight: 600;
      color: #007aff;
    }

    .bus-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }

    .bus-details {
      font-size: 16px;
      color: #333;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .stops-list {
      margin-top: 8px;
      padding-left: 12px;
      border-left: 3px solid #007aff33;
    }

    .stop-item {
      font-size: 15px;
      color: #555;
      margin: 4px 0;
      transition: all 0.2s;
    }

    .highlight {
      color: #007aff;
      font-weight: 600;
      font-size: 16px;
      transform: translateX(3px);
    }

    h2 {
      margin-top: 0;
      margin-bottom: 14px;
      font-size: 22px;
      color: #333;
      text-align: center;
    }

    @media (max-width: 768px) {
      .info-card {
        bottom: 0;
        top: auto;
        left: 50%;
        transform: translateX(-50%);
        width: 95%;
        height: auto;
        max-height: 55%;
        border-radius: 20px 20px 0 0;
      }

      .bus-title { font-size: 18px; }
      .bus-details { font-size: 14px; }
      .stop-item { font-size: 13px; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="info-card">
    <h2>üöå Active Buses</h2>
    <div id="busList"></div>
  </div>

  <!-- ‚úÖ Google Maps Loader -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxLu0osGhSyZCJt5TGO-gSPuGydL_u7XE&callback=initMap"
    async defer></script>
</body>
</html>
